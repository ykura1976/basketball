<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÄ „Éê„Çπ„Ç±Ë®òÈå≤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }

        .sync-indicator.syncing {
            display: block;
            color: #667eea;
        }

        .sync-indicator.success {
            display: block;
            color: #2ecc71;
        }

        .sync-indicator.error {
            display: block;
            color: #ff4757;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid white;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
        }

        .tab-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 80px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stepper button {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 10px;
            background: #667eea;
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stepper button:active {
            transform: scale(0.95);
        }

        .stepper .value {
            flex: 1;
            text-align: center;
            font-size: 26px;
            font-weight: bold;
            color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .stats-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 12px;
            color: white;
            text-align: center;
        }

        .stats-display h3 {
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .stats-display .percentage {
            font-size: 1.8em;
            font-weight: bold;
        }

        .save-btn, .primary-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-btn:active, .primary-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled, .primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .game-checkbox {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .game-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.1em;
            padding-right: 40px;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .stat-box {
            text-align: center;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 8px;
        }

        .stat-box .label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 4px;
        }

        .stat-box .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        input[type="date"], input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .saved-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            z-index: 1000;
        }

        .saved-indicator.show {
            opacity: 1;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: bold;
            margin: 25px 0 15px 0;
            color: #333;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .team-code-display {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .team-code-display .code {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 2px;
            margin: 10px 0;
        }

        .player-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-info .number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .my-data-badge {
            background: #2ecc71;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .ranking-table th {
            background: #f7f7f7;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            font-size: 0.9em;
        }

        .ranking-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }

        .top-record {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .top-record .trophy {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .top-record .value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .close-modal {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncIndicator">ÂêåÊúü‰∏≠...</div>
    
    <div class="container">
        <div class="header">
            <h1>üèÄ „Éê„Çπ„Ç±Ë®òÈå≤</h1>
            <p>ÊàêÈï∑„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</p>
        </div>

        <div class="mode-switch">
            <button class="mode-btn active" onclick="switchMode('personal')">üë§ ÂÄã‰∫∫</button>
            <button class="mode-btn" onclick="switchMode('team')">üë• „ÉÅ„Éº„É†</button>
        </div>

        <div id="personalMode">
            <div class="tab-bar">
                <button class="tab active" onclick="switchTab('input')">üìù Ë®òÈå≤</button>
                <button class="tab" onclick="switchTab('list')">üìä Â±•Ê≠¥</button>
                <button class="tab" onclick="switchTab('ranking')">üèÜ „É©„É≥„Ç≠„É≥„Ç∞</button>
                <button class="tab" onclick="switchTab('graph')">üìà „Ç∞„É©„Éï</button>
                <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>

            <div id="inputTab" class="tab-content active">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Êñ∞„Åó„ÅÑË©¶Âêà„ÇíË®òÈå≤</h2>
                    
                    <div class="input-group">
                        <label>Ë©¶ÂêàÊó•</label>
                        <input type="date" id="gameDate">
                    </div>

                    <div class="input-group">
                        <label>ÂØæÊà¶Áõ∏Êâã</label>
                        <input type="text" id="opponent" placeholder="Áõ∏Êâã„ÉÅ„Éº„É†Âêç„ÇíÂÖ•Âäõ">
                    </div>

                    <div class="input-group">
                        <label>„Éó„É¨„Ç§ÊôÇÈñìÔºàÂàÜÔºâ</label>
                        <input type="number" id="playTime" value="0" min="0" max="200">
                    </div>

                    <div class="section-title">üèÄ „Ç∑„É•„Éº„Éà</div>
                    
                    <div class="input-group">
                        <label>2„Éù„Ç§„É≥„ÉàÊàêÂäü</label>
                        <div class="stepper">
                            <button onclick="changeValue('twoPointsMade', -1)">‚àí</button>
                            <div class="value" id="twoPointsMade">0</div>
                            <button onclick="changeValue('twoPointsMade', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>2„Éù„Ç§„É≥„ÉàË©¶Êäï</label>
                        <div class="stepper">
                            <button onclick="changeValue('twoPointsAttempted', -1)">‚àí</button>
                            <div class="value" id="twoPointsAttempted">0</div>
                            <button onclick="changeValue('twoPointsAttempted', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>3„Éù„Ç§„É≥„ÉàÊàêÂäü</label>
                        <div class="stepper">
                            <button onclick="changeValue('threePointsMade', -1)">‚àí</button>
                            <div class="value" id="threePointsMade">0</div>
                            <button onclick="changeValue('threePointsMade', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>3„Éù„Ç§„É≥„ÉàË©¶Êäï</label>
                        <div class="stepper">
                            <button onclick="changeValue('threePointsAttempted', -1)">‚àí</button>
                            <div class="value" id="threePointsAttempted">0</div>
                            <button onclick="changeValue('threePointsAttempted', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Éï„É™„Éº„Çπ„É≠„ÉºÊàêÂäü</label>
                        <div class="stepper">
                            <button onclick="changeValue('freeThrowsMade', -1)">‚àí</button>
                            <div class="value" id="freeThrowsMade">0</div>
                            <button onclick="changeValue('freeThrowsMade', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Éï„É™„Éº„Çπ„É≠„ÉºË©¶Êäï</label>
                        <div class="stepper">
                            <button onclick="changeValue('freeThrowsAttempted', -1)">‚àí</button>
                            <div class="value" id="freeThrowsAttempted">0</div>
                            <button onclick="changeValue('freeThrowsAttempted', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stats-display">
                            <h3>2PÊàêÂäüÁéá</h3>
                            <div class="percentage" id="twoPointPercentage">0%</div>
                        </div>
                        <div class="stats-display">
                            <h3>3PÊàêÂäüÁéá</h3>
                            <div class="percentage" id="threePointPercentage">0%</div>
                        </div>
                        <div class="stats-display">
                            <h3>FTÊàêÂäüÁéá</h3>
                            <div class="percentage" id="freeThrowPercentage">0%</div>
                        </div>
                        <div class="stats-display">
                            <h3>Á∑èÂæóÁÇπ</h3>
                            <div class="percentage" id="totalPoints">0</div>
                        </div>
                    </div>

                    <div class="section-title">üéØ „É™„Éê„Ç¶„É≥„Éâ</div>

                    <div class="input-group">
                        <label>„Ç™„Éï„Çß„É≥„Çπ„É™„Éê„Ç¶„É≥„Éâ</label>
                        <div class="stepper">
                            <button onclick="changeValue('offensiveRebounds', -1)">‚àí</button>
                            <div class="value" id="offensiveRebounds">0</div>
                            <button onclick="changeValue('offensiveRebounds', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Éá„Ç£„Éï„Çß„É≥„Çπ„É™„Éê„Ç¶„É≥„Éâ</label>
                        <div class="stepper">
                            <button onclick="changeValue('defensiveRebounds', -1)">‚àí</button>
                            <div class="value" id="defensiveRebounds">0</div>
                            <button onclick="changeValue('defensiveRebounds', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="section-title">üìä „Åù„ÅÆ‰ªñ„ÅÆÁµ±Ë®à</div>

                    <div class="input-group">
                        <label>„Ç¢„Ç∑„Çπ„Éà</label>
                        <div class="stepper">
                            <button onclick="changeValue('assists', -1)">‚àí</button>
                            <div class="value" id="assists">0</div>
                            <button onclick="changeValue('assists', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Çπ„ÉÜ„Ç£„Éº„É´</label>
                        <div class="stepper">
                            <button onclick="changeValue('steals', -1)">‚àí</button>
                            <div class="value" id="steals">0</div>
                            <button onclick="changeValue('steals', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Éñ„É≠„ÉÉ„ÇØ</label>
                        <div class="stepper">
                            <button onclick="changeValue('blocks', -1)">‚àí</button>
                            <div class="value" id="blocks">0</div>
                            <button onclick="changeValue('blocks', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Çø„Éº„É≥„Ç™„Éº„Éê„Éº</label>
                        <div class="stepper">
                            <button onclick="changeValue('turnovers', -1)">‚àí</button>
                            <div class="value" id="turnovers">0</div>
                            <button onclick="changeValue('turnovers', 1)">Ôºã</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>„Éï„Ç°„Ç¶„É´</label>
                        <div class="stepper">
                            <button onclick="changeValue('fouls', -1)">‚àí</button>
                            <div class="value" id="fouls">0</div>
                            <button onclick="changeValue('fouls', 1)">Ôºã</button>
                        </div>
                    </div>

                    <button class="save-btn" id="saveGameBtn" onclick="savePersonalGame()">Ë®òÈå≤„Çí‰øùÂ≠ò</button>
                </div>
            </div>

            <div id="listTab" class="tab-content">
                <div id="gameList"></div>
            </div>

            <div id="rankingTab" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">üèÜ „Éô„Çπ„Éà„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h2>
                    <div id="topPoints"></div>
                </div>
            </div>

            <div id="graphTab" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">„Ç∑„É•„Éº„ÉàÊàêÂäüÁéá„ÅÆÊé®Áßª</h2>
                    <div class="chart-container">
                        <canvas id="shootingChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">üîó „ÉÅ„Éº„É†ÈÄ£Êê∫</h2>
                    <div id="teamStatus"></div>
                    
                    <button class="primary-btn" style="margin-bottom: 10px;" onclick="showCreateTeamModal()">
                        üÜï Êñ∞„Åó„ÅÑ„ÉÅ„Éº„É†„Çí‰ΩúÊàê
                    </button>
                    
                    <button class="primary-btn" style="background: #3498db;" onclick="showJoinTeamModal()">
                        üëã „ÉÅ„Éº„É†„Å´ÂèÇÂä†
                    </button>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;">üë§ ÂÄã‰∫∫„É¢„Éº„ÉâË°®Á§∫Ë®≠ÂÆö</h2>
                    <div class="input-group">
                        <label>ÂÄã‰∫∫„É¢„Éº„Éâ„ÅßË°®Á§∫„Åô„ÇãÈÅ∏Êâã</label>
                        <select id="myPlayerSelect" onchange="changeMyPlayer()">
                            <option value="">ÈÅ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;">üë• ÈÅ∏ÊâãÁôªÈå≤</h2>
                    <div class="input-group">
                        <label>ËÉåÁï™Âè∑</label>
                        <input type="number" id="playerNumber" placeholder="‰æã: 7" min="0" max="99">
                    </div>
                    <div class="input-group">
                        <label>ÂêçÂâç</label>
                        <input type="text" id="playerName" placeholder="‰æã: Â±±Áî∞ Ëä±Â≠ê">
                    </div>
                    <button class="primary-btn" style="margin-top: 15px;" onclick="addPlayer()">ÈÅ∏Êâã„ÇíËøΩÂä†</button>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;">ÁôªÈå≤Ê∏à„ÅøÈÅ∏Êâã</h2>
                    <div id="playerList"></div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 20px;">üì• „Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                    <button class="primary-btn" style="background: #2ecc71; margin-bottom: 10px;" onclick="exportData()">
                        üíæ „Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                    </button>
                    
                    <button class="primary-btn" style="background: #3498db;" onclick="document.getElementById('importFile').click()">
                        üìÇ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
        </div>

        <div id="teamMode" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üë• „ÉÅ„Éº„É†Áµ±Ë®à</h2>
                <div id="teamStats"></div>
            </div>
        </div>
    </div>

    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">üÜï „ÉÅ„Éº„É†„Çí‰ΩúÊàê</h2>
            <div class="input-group">
                <label>„ÉÅ„Éº„É†Âêç</label>
                <input type="text" id="newTeamName" placeholder="‰æã: „Åï„Åè„Çâ„Éê„Çπ„Ç±ÈÉ®">
            </div>
            <button class="primary-btn" onclick="createTeam()">‰ΩúÊàê</button>
            <button class="close-modal" onclick="closeModal('createTeamModal')">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div id="joinTeamModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">üëã „ÉÅ„Éº„É†„Å´ÂèÇÂä†</h2>
            <div class="input-group">
                <label>„ÉÅ„Éº„É†„Ç≥„Éº„Éâ</label>
                <input type="text" id="joinTeamCode" placeholder="6Ê°Å„ÅÆ„Ç≥„Éº„Éâ" maxlength="6">
            </div>
            <button class="primary-btn" onclick="joinTeam()">ÂèÇÂä†</button>
            <button class="close-modal" onclick="closeModal('joinTeamModal')">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div class="saved-indicator" id="savedIndicator">‚úì ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwbPUgd-QAVhwBmhyBwiCtS1GDvZks0imrC78ZsJu5dV-d-Zt6reEW0oi1Lkc_MbW_agQ/exec';
        
        let currentMode = 'personal';
        let personalGames = [];
        let teamGames = [];
        let players = [];
        let myPlayerId = null;
        let teamData = null;
        let charts = {};
        
        let stats = {
            twoPointsMade: 0, twoPointsAttempted: 0,
            threePointsMade: 0, threePointsAttempted: 0,
            freeThrowsMade: 0, freeThrowsAttempted: 0,
            offensiveRebounds: 0, defensiveRebounds: 0,
            assists: 0, steals: 0, blocks: 0, turnovers: 0, fouls: 0
        };

        function showSyncIndicator(status, message) {
            const indicator = document.getElementById('syncIndicator');
            indicator.className = 'sync-indicator ' + status;
            indicator.textContent = message;
            
            if (status === 'success' || status === 'error') {
                setTimeout(function() {
                    indicator.className = 'sync-indicator';
                }, 3000);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('basketballData');
                if (saved) {
                    const data = JSON.parse(saved);
                    personalGames = data.personalGames || [];
                    teamGames = data.teamGames || [];
                    players = data.players || [];
                    myPlayerId = data.myPlayerId || null;
                    teamData = data.teamData || null;
                }
            } catch (e) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
            }
        }

        function saveData() {
            const data = {
                personalGames: personalGames,
                teamGames: teamGames,
                players: players,
                myPlayerId: myPlayerId,
                teamData: teamData
            };
            localStorage.setItem('basketballData', JSON.stringify(data));
            showSavedIndicator();
        }

        function showSavedIndicator() {
            const indicator = document.getElementById('savedIndicator');
            indicator.classList.add('show');
            setTimeout(function() {
                indicator.classList.remove('show');
            }, 2000);
        }

        function showCreateTeamModal() {
            document.getElementById('createTeamModal').classList.add('active');
        }

        function showJoinTeamModal() {
            document.getElementById('joinTeamModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function generateTeamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function createTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            if (!teamName) {
                alert('„ÉÅ„Éº„É†Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showSyncIndicator('syncing', '„ÉÅ„Éº„É†„Çí‰ΩúÊàê‰∏≠...');
            
            const teamCode = generateTeamCode();
            
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'createTeam',
                    teamName: teamName,
                    teamCode: teamCode
                })
            })
            .then(function() {
                teamData = {
                    name: teamName,
                    code: teamCode,
                    createdAt: new Date().toISOString()
                };
                saveData();
                closeModal('createTeamModal');
                displayTeamStatus();
                showSyncIndicator('success', '„ÉÅ„Éº„É†‰ΩúÊàêÂÆå‰∫Ü!');
                
                alert('‚úÖ „ÉÅ„Éº„É†„Äå' + teamName + '„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ\n\n„ÉÅ„Éº„É†„Ç≥„Éº„Éâ: ' + teamCode + '\n\n„Åì„ÅÆ„Ç≥„Éº„Éâ„ÇíÂèãÈÅî„Å´ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            })
            .catch(function(error) {
                console.error('„Ç®„É©„Éº:', error);
                showSyncIndicator('error', '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                alert('‚ùå „ÉÅ„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            });
        }

        function joinTeam() {
            const teamCode = document.getElementById('joinTeamCode').value.trim().toUpperCase();
            if (!teamCode || teamCode.length !== 6) {
                alert('Ê≠£„Åó„ÅÑ6Ê°Å„ÅÆ„ÉÅ„Éº„É†„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showSyncIndicator('syncing', '„ÉÅ„Éº„É†„Å´ÂèÇÂä†‰∏≠...');
            
            teamData = {
                name: '„ÉÅ„Éº„É†',
                code: teamCode,
                joinedAt: new Date().toISOString()
            };
            
            saveData();
            closeModal('joinTeamModal');
            displayTeamStatus();
            syncWithServer();
            
            showSyncIndicator('success', '„ÉÅ„Éº„É†ÂèÇÂä†ÂÆå‰∫Ü!');
            alert('‚úÖ „ÉÅ„Éº„É†„Å´ÂèÇÂä†„Åó„Åæ„Åó„ÅüÔºÅ\n\n„ÉÅ„Éº„É†„Ç≥„Éº„Éâ: ' + teamCode);
        }

        function syncWithServer() {
            if (!teamData) return;
            
            showSyncIndicator('syncing', 'ÂêåÊúü‰∏≠...');
            
            const syncData = {
                action: 'syncData',
                teamCode: teamData.code,
                players: players,
                personalGames: personalGames,
                teamGames: teamGames
            };
            
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(syncData)
            })
            .then(function() {
                showSyncIndicator('success', 'ÂêåÊúüÂÆå‰∫Ü!');
            })
            .catch(function(error) {
                console.error('ÂêåÊúü„Ç®„É©„Éº:', error);
                showSyncIndicator('error', 'ÂêåÊúüÂ§±Êïó');
            });
        }

        function displayTeamStatus() {
            const statusEl = document.getElementById('teamStatus');
            
            if (!teamData) {
                statusEl.innerHTML = '<p style="color: #999; text-align: center;">„ÉÅ„Éº„É†„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            statusEl.innerHTML = 
                '<div class="team-code-display">' +
                '<div style="font-size: 0.9em; color: #666;">ÁèæÂú®„ÅÆ„ÉÅ„Éº„É†</div>' +
                '<div style="font-size: 1.3em; font-weight: bold; color: #667eea; margin: 10px 0;">' + teamData.name + '</div>' +
                '<div style="font-size: 0.9em; color: #666;">„ÉÅ„Éº„É†„Ç≥„Éº„Éâ</div>' +
                '<div class="code">' + teamData.code + '</div>' +
                '<button class="primary-btn" style="background: #2ecc71; margin-top: 15px;" onclick="syncWithServer()">‰ªä„Åô„ÅêÂêåÊúü</button>' +
                '<button class="primary-btn" style="background: #e74c3c; margin-top: 10px;" onclick="leaveTeam()">„ÉÅ„Éº„É†„Åã„ÇâÈÄÄÂá∫</button>' +
                '</div>';
        }

        function leaveTeam() {
            if (confirm('Êú¨ÂΩì„Å´„ÉÅ„Éº„É†„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                teamData = null;
                saveData();
                displayTeamStatus();
                alert('‚úÖ „ÉÅ„Éº„É†„Åã„ÇâÈÄÄÂá∫„Åó„Åæ„Åó„Åü');
            }
        }

        document.getElementById('gameDate').valueAsDate = new Date();

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            if (mode === 'personal') {
                document.querySelector('.mode-btn:nth-child(1)').classList.add('active');
                document.getElementById('personalMode').style.display = 'block';
                document.getElementById('teamMode').style.display = 'none';
                displayGames();
            } else if (mode === 'team') {
                document.querySelector('.mode-btn:nth-child(2)').classList.add('active');
                document.getElementById('personalMode').style.display = 'none';
                document.getElementById('teamMode').style.display = 'block';
                displayTeamStats();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('#personalMode .tab').forEach(function(t) {
                t.classList.remove('active');
            });
            document.querySelectorAll('#personalMode .tab-content').forEach(function(c) {
                c.classList.remove('active');
            });
            
            const tabs = ['input', 'list', 'ranking', 'graph', 'settings'];
            const index = tabs.indexOf(tab);
            document.querySelector('#personalMode .tab:nth-child(' + (index + 1) + ')').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'graph') updateCharts();
            if (tab === 'settings') { 
                displayPlayers(); 
                updateMyPlayerSelect();
                displayTeamStatus();
            }
            if (tab === 'ranking') displayRankings();
            if (tab === 'list') displayGames();
        }

        function changeValue(key, delta) {
            stats[key] = Math.max(0, stats[key] + delta);
            
            if (key === 'twoPointsMade' && stats.twoPointsMade > stats.twoPointsAttempted) {
                stats.twoPointsAttempted = stats.twoPointsMade;
            }
            if (key === 'twoPointsAttempted' && stats.twoPointsMade > stats.twoPointsAttempted) {
                stats.twoPointsMade = stats.twoPointsAttempted;
            }
            if (key === 'threePointsMade' && stats.threePointsMade > stats.threePointsAttempted) {
                stats.threePointsAttempted = stats.threePointsMade;
            }
            if (key === 'threePointsAttempted' && stats.threePointsMade > stats.threePointsAttempted) {
                stats.threePointsMade = stats.threePointsAttempted;
            }
            if (key === 'freeThrowsMade' && stats.freeThrowsMade > stats.freeThrowsAttempted) {
                stats.freeThrowsAttempted = stats.freeThrowsMade;
            }
            if (key === 'freeThrowsAttempted' && stats.freeThrowsMade > stats.freeThrowsAttempted) {
                stats.freeThrowsMade = stats.freeThrowsAttempted;
            }
            
            updateDisplay();
        }

        function updateDisplay() {
            Object.keys(stats).forEach(function(key) {
                const el = document.getElementById(key);
                if (el) el.textContent = stats[key];
            });
            
            const twoP = stats.twoPointsAttempted > 0 ? ((stats.twoPointsMade / stats.twoPointsAttempted) * 100).toFixed(1) : '0';
            const threeP = stats.threePointsAttempted > 0 ? ((stats.threePointsMade / stats.threePointsAttempted) * 100).toFixed(1) : '0';
            const ft = stats.freeThrowsAttempted > 0 ? ((stats.freeThrowsMade / stats.freeThrowsAttempted) * 100).toFixed(1) : '0';
            const totalPoints = (stats.twoPointsMade * 2) + (stats.threePointsMade * 3) + stats.freeThrowsMade;
            
            document.getElementById('twoPointPercentage').textContent = twoP + '%';
            document.getElementById('threePointPercentage').textContent = threeP + '%';
            document.getElementById('freeThrowPercentage').textContent = ft + '%';
            document.getElementById('totalPoints').textContent = totalPoints;
        }

        function savePersonalGame() {
            const date = document.getElementById('gameDate').value;
            if (!date) {
                alert('Ë©¶ÂêàÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const saveBtn = document.getElementById('saveGameBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';

            const game = {
                id: Date.now(),
                date: date,
                opponent: document.getElementById('opponent').value.trim(),
                playTime: parseInt(document.getElementById('playTime').value) || 0,
                playerId: myPlayerId,
                twoPointsMade: stats.twoPointsMade,
                twoPointsAttempted: stats.twoPointsAttempted,
                threePointsMade: stats.threePointsMade,
                threePointsAttempted: stats.threePointsAttempted,
                freeThrowsMade: stats.freeThrowsMade,
                freeThrowsAttempted: stats.freeThrowsAttempted,
                offensiveRebounds: stats.offensiveRebounds,
                defensiveRebounds: stats.defensiveRebounds,
                assists: stats.assists,
                steals: stats.steals,
                blocks: stats.blocks,
                turnovers: stats.turnovers,
                fouls: stats.fouls,
                totalRebounds: stats.offensiveRebounds + stats.defensiveRebounds,
                twoPointPercentage: stats.twoPointsAttempted > 0 ? ((stats.twoPointsMade / stats.twoPointsAttempted) * 100).toFixed(1) : '0',
                threePointPercentage: stats.threePointsAttempted > 0 ? ((stats.threePointsMade / stats.threePointsAttempted) * 100).toFixed(1) : '0',
                freeThrowPercentage: stats.freeThrowsAttempted > 0 ? ((stats.freeThrowsMade / stats.freeThrowsAttempted) * 100).toFixed(1) : '0',
                totalPoints: (stats.twoPointsMade * 2) + (stats.threePointsMade * 3) + stats.freeThrowsMade,
                source: 'personal'
            };

            personalGames.unshift(game);
            saveData();
            
            if (teamData) {
                syncWithServer();
            }
            
            displayGames();
            resetForm();
            
            saveBtn.disabled = false;
            saveBtn.textContent = 'Ë®òÈå≤„Çí‰øùÂ≠ò';
            
            alert('‚úÖ Ë©¶ÂêàË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function resetForm() {
            Object.keys(stats).forEach(function(key) {
                stats[key] = 0;
            });
            document.getElementById('gameDate').valueAsDate = new Date();
            document.getElementById('opponent').value = '';
            document.getElementById('playTime').value = 0;
            updateDisplay();
        }

        function displayGames() {
            const gameList = document.getElementById('gameList');
            
            const myGames = personalGames.filter(function(g) {
                return !g.playerId || g.playerId === myPlayerId;
            });
            
            if (myGames.length === 0) {
                gameList.innerHTML = '<div class="empty-state"><div class="icon">üèÄ</div><h3>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3><p>ÊúÄÂàù„ÅÆË©¶Âêà„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p></div>';
                return;
            }

            gameList.innerHTML = myGames.map(function(g) {
                const dateObj = new Date(g.date);
                const dateStr = dateObj.toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric'});
                const sourceLabel = g.source === 'team' ? ' <span style="background: #2ecc71; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">„ÉÅ„Éº„É†Ë®òÈå≤</span>' : '';
                
                return '<div class="game-item">' +
                    '<div class="game-date">' + dateStr + 
                    (g.opponent ? ' vs ' + g.opponent : '') + 
                    (g.playTime ? ' (' + g.playTime + 'ÂàÜ)' : '') + 
                    sourceLabel +
                    '</div>' +
                    '<div class="game-stats">' +
                    '<div class="stat-box"><div class="label">Á∑èÂæóÁÇπ</div><div class="value">' + g.totalPoints + 'ÁÇπ</div></div>' +
                    '<div class="stat-box"><div class="label">2PÁéá</div><div class="value">' + g.twoPointPercentage + '%</div></div>' +
                    '<div class="stat-box"><div class="label">3PÁéá</div><div class="value">' + g.threePointPercentage + '%</div></div>' +
                    '<div class="stat-box"><div class="label">FTÁéá</div><div class="value">' + g.freeThrowPercentage + '%</div></div>' +
                    '<div class="stat-box"><div class="label">„É™„Éê„Ç¶„É≥„Éâ</div><div class="value">' + g.totalRebounds + '</div></div>' +
                    '<div class="stat-box"><div class="label">„Ç¢„Ç∑„Çπ„Éà</div><div class="value">' + g.assists + '</div></div>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function displayTeamStats() {
            const statsEl = document.getElementById('teamStats');
            
            if (!teamData) {
                statsEl.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><h3>„ÉÅ„Éº„É†„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</h3><p>Ë®≠ÂÆö„Çø„Éñ„Åã„Çâ„ÉÅ„Éº„É†„Çí‰ΩúÊàê„Åæ„Åü„ÅØÂèÇÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div>';
                return;
            }
            
            const totalGames = personalGames.length;
            const totalPoints = personalGames.reduce(function(sum, g) {
                return sum + (g.totalPoints || 0);
            }, 0);
            const avgPoints = totalGames > 0 ? (totalPoints / totalGames).toFixed(1) : 0;
            
            statsEl.innerHTML = 
                '<div class="team-code-display">' +
                '<div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 10px;">üìä „ÉÅ„Éº„É†Áµ±Ë®à</div>' +
                '<div style="font-size: 1.1em; margin: 10px 0;">„ÉÅ„Éº„É†Âêç: ' + teamData.name + '</div>' +
                '<div style="font-size: 0.9em; color: #666; margin-bottom: 20px;">„ÉÅ„Éº„É†„Ç≥„Éº„Éâ: ' + teamData.code + '</div>' +
                '</div>' +
                '<div class="stats-grid">' +
                '<div class="stats-display"><h3>Á∑èË©¶ÂêàÊï∞</h3><div class="percentage">' + totalGames + '</div></div>' +
                '<div class="stats-display"><h3>Âπ≥ÂùáÂæóÁÇπ</h3><div class="percentage">' + avgPoints + '</div></div>' +
                '</div>' +
                '<div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 10px;">' +
                '<p style="color: #666; font-size: 0.9em; text-align: center;">„ÉÅ„Éº„É†„É°„É≥„Éê„Éº„ÅåË®òÈå≤„ÇíËøΩÂä†„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´Áµ±Ë®à„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>' +
                '</div>';
        }

        function displayRankings() {
            const myGames = personalGames.filter(function(g) {
                return !g.playerId || g.playerId === myPlayerId;
            });
            
            if (myGames.length === 0) {
                document.getElementById('topPoints').innerHTML = '<p style="text-align: center; color: #999;">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            const topPoints = myGames.slice().sort(function(a, b) {
                return b.totalPoints - a.totalPoints;
            }).slice(0, 10);

            if (topPoints.length > 0) {
                const top = topPoints[0];
                const dateObj = new Date(top.date);
                const dateStr = dateObj.toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric'});
                
                let html = '<div class="top-record">' +
                    '<div class="trophy">üèÜ</div>' +
                    '<div style="font-size: 1.2em; margin-bottom: 10px;">ÊúÄÈ´òÂæóÁÇπ</div>' +
                    '<div class="value">' + top.totalPoints + 'ÁÇπ</div>' +
                    '<div style="font-size: 1.1em; opacity: 0.95;">' + dateStr;
                
                if (top.opponent) {
                    html += '<br>vs ' + top.opponent;
                }
                
                html += '</div></div>';
                
                document.getElementById('topPoints').innerHTML = html;
            }
        }

        function updateCharts() {
            const myGames = personalGames.filter(function(g) {
                return !g.playerId || g.playerId === myPlayerId;
            });
            
            if (myGames.length === 0) return;

            const sorted = myGames.slice().reverse();
            const labels = sorted.map(function(g) {
                const d = new Date(g.date).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'});
                return g.opponent ? d + ' vs ' + g.opponent : d;
            });

            if (charts.shooting) charts.shooting.destroy();
            charts.shooting = new Chart(document.getElementById('shootingChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '2PÊàêÂäüÁéá',
                        data: sorted.map(function(g) { return parseFloat(g.twoPointPercentage); }),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: '3PÊàêÂäüÁéá',
                        data: sorted.map(function(g) { return parseFloat(g.threePointPercentage); }),
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'FTÊàêÂäüÁéá',
                        data: sorted.map(function(g) { return parseFloat(g.freeThrowPercentage); }),
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(v) { return v + '%'; } }
                        }
                    }
                }
            });
        }

        function addPlayer() {
            const num = document.getElementById('playerNumber').value;
            const name = document.getElementById('playerName').value.trim();

            if (!num || !name) { 
                alert('ËÉåÁï™Âè∑„Å®ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); 
                return; 
            }
            
            const exists = players.some(function(p) {
                return p.number === num;
            });
            
            if (exists) { 
                alert('„Åì„ÅÆËÉåÁï™Âè∑„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô'); 
                return; 
            }

            const player = { 
                id: Date.now().toString(), 
                number: num, 
                name: name 
            };
            players.push(player);
            
            if (!myPlayerId) myPlayerId = player.id;
            
            saveData();
            
            if (teamData) {
                syncWithServer();
            }
            
            displayPlayers();
            updateMyPlayerSelect();

            document.getElementById('playerNumber').value = '';
            document.getElementById('playerName').value = '';
            
            alert('‚úÖ ' + name + ' #' + num + ' „ÇíÁôªÈå≤„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function changeMyPlayer() {
            myPlayerId = document.getElementById('myPlayerSelect').value || null;
            saveData();
            displayGames();
            
            if (myPlayerId) {
                const p = players.find(function(pl) {
                    return pl.id === myPlayerId;
                });
                alert('‚úÖ ÂÄã‰∫∫„É¢„Éº„ÉâË°®Á§∫„Çí„Äå' + p.name + ' #' + p.number + '„Äç„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü');
            }
        }

        function updateMyPlayerSelect() {
            const sel = document.getElementById('myPlayerSelect');
            sel.innerHTML = '<option value="">ÈÅ∏Êâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            players.forEach(function(p) {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name + ' #' + p.number;
                if (p.id === myPlayerId) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function displayPlayers() {
            const playerList = document.getElementById('playerList');
            
            if (players.length === 0) {
                playerList.innerHTML = '<p style="text-align: center; color: #999;">„Åæ„Å†ÈÅ∏Êâã„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }

            playerList.innerHTML = players.map(function(p) {
                const isMyPlayer = p.id === myPlayerId;
                
                return '<div class="player-item">' +
                    '<div class="player-info">' +
                    '<div>' +
                    '<span class="number">#' + p.number + '</span>' +
                    '<span style="font-weight: bold; margin-left: 10px;">' + p.name + '</span>' +
                    '</div>' +
                    (isMyPlayer ? '<span class="my-data-badge">ÂÄã‰∫∫„É¢„Éº„ÉâË°®Á§∫‰∏≠</span>' : '') +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function exportData() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                personalGames: personalGames,
                teamGames: teamGames,
                players: players,
                myPlayerId: myPlayerId,
                teamData: teamData
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '„Éê„Çπ„Ç±Ë®òÈå≤_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (confirm('‚ö†Ô∏è „Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô\n\nÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                        personalGames = data.personalGames || [];
                        teamGames = data.teamGames || [];
                        players = data.players || [];
                        myPlayerId = data.myPlayerId || null;
                        teamData = data.teamData || null;
                        saveData();
                        displayGames();
                        displayPlayers();
                        alert('‚úÖ „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                        location.reload();
                    }
                } catch (err) {
                    alert('‚ùå „Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        loadData();
        updateDisplay();
        displayGames();
        displayPlayers();
        updateMyPlayerSelect();
        displayTeamStatus();
    </script>
</body>
</html>
